<!--
Copyright (c) CLMS. All rights reserved.
Licensed under the AGPL-3.0 license. See LICENSE file in the project root for full license information.-->

<ExposedApi DateCreated="" Model_Name="pastOrders" Model_Description="Receives a Collection of Stock on Hand regarding the Items. If all entries are imported successfully, returns a success message. If not, returns a failure message." Version="0.1.0">
  <Operations>
    <Operation Verb="Post" Path="import" ReturnDataType="Domain.Response" Name="Import" Description="Import Past Orders" AllowAnonymousUsers="False" AllowAllAuthenticated="True" EnableAccessLog="True" ResponseSample="" RequestSample="" AllowPermisssions="" ApplicationTags="">
      <Parameters>
        <Parameter DataType="Collection[Domain.PastOrder]" Required="True" Name="pOrders" Description="" />
      </Parameters>
      <Code>function Domain.Response Import(Collection[Domain.PastOrder] pOrders)
{
	string message;
	
	foreach Domain.PastOrder: pOrder in pOrders {
	    DebugLib.Logger.WriteInfoLine("Caller : " + pOrder.Caller);
		if (pOrder.Item == null || pOrder.Warehouse == null) {
			message = message + pOrder.Id + " ,"	;
		    continue;
		}
		Domain.Item existingItem = Domain.Item.Find(s=&gt; s.SKU == pOrder.Item.SKU).First();
		DebugLib.Logger.WriteInfoLine("Item: " + pOrder.Item.SKU);
		Domain.Warehouse existingWarehouse = Domain.Warehouse.Find(w=&gt; w.Code == pOrder.Warehouse.Code).First();
		if (existingItem == null || existingWarehouse == null) {
		    message = message + pOrder.Id + " ,"	;
		    continue;
		}
		Domain.PastOrder newPastOrder;
		newPastOrder.Warehouse = existingWarehouse;
		newPastOrder.Item = existingItem;
		newPastOrder.OrderNumber = pOrder.OrderNumber;
		newPastOrder.WrittenDate = pOrder.WrittenDate;
		newPastOrder.NotBeforeDate = pOrder.NotBeforeDate;
		if (pOrder.Caller == "Vitacress" || pOrder.Caller == "Schreiber") {
			int supPack = existingItem.SupplierPackSize;
			newPastOrder.QuantityOrdered = (supPack * pOrder.QuantityOrdered) as int;
			newPastOrder.QuantityReceived = (supPack * pOrder.QuantityReceived) as int;
		}
		else {
			newPastOrder.QuantityOrdered = pOrder.QuantityOrdered;	
			newPastOrder.QuantityReceived = pOrder.QuantityReceived;
		}
		
		newPastOrder.ReceiveDate = pOrder.ReceiveDate;
		newPastOrder.Save();
	}
	if (!string.IsNullOrEmpty(message)) {
	    DebugLib.Logger.WriteWarnLine("Error message: " + message);
	    return Domain.Response.GenerateResponse("Failed", "Failed to import the entries with Ids " + message, "", "-1");
	}
	return Domain.Response.GenerateResponse("Succeed", "All entries imported successfully.", "", "1");
}</Code>
      <CachingOptions CachePerUser="false" OperationIsCached="false" OverrideDefaultCachingSettings="false" UseCustomExpirationMethod="false" ExpirationDays="0" ExpirationHours="0" ExpirationMinutes="3" ExpirationSeconds="0" ExpirationMilliseconds="0" CacheMode="None">function TimeSpan Expiration(
	Collection[Domain.PastOrder] pOrders,
	Domain.Response response
)
{ 
	 return CommonLib.Utilities.CreateTimeSpan(0, 1, 0); 
}</CachingOptions>
    </Operation>
  </Operations>
  <DataContracts>
    <DataContract Name="" Class="Domain.Item" BaseClass="">
      <Members>
        <Member Name="SKU" DataType="string" Checked="True" />
        <Member Name="Description" DataType="string" Checked="True" />
        <Member Name="UPC" DataType="string" Checked="True" />
        <Member Name="ItemsForecast" DataType="Collection[Domain.Sales]" Checked="False" />
        <Member Name="StocksOnHand" DataType="Collection[Domain.StockOnHand]" Checked="False" />
        <Member Name="MinimumQuantity" DataType="Domain.MinimumQuantity" Checked="False" />
        <Member Name="AvgDailyDemand" DataType="decimal" Checked="False" />
        <Member Name="SupplierCapacities" DataType="Collection[Domain.SupplierCapacity]" Checked="False" />
        <Member Name="Supplier" DataType="Domain.Supplier" Checked="False" />
        <Member Name="BusinessUnit" DataType="Domain.BusinessUnit" Checked="False" />
        <Member Name="Category" DataType="Domain.Category" Checked="False" />
        <Member Name="SubCategory" DataType="Domain.SubCategory" Checked="False" />
        <Member Name="BaseUnit" DataType="Domain.BaseUnit" Checked="False" />
        <Member Name="DeliverySchedules" DataType="Collection[Domain.DeliverySchedule]" Checked="False" />
        <Member Name="Agreements" DataType="Collection[Domain.Agreement]" Checked="False" />
        <Member Name="Notifications" DataType="Collection[Domain.Notification]" Checked="False" />
        <Member Name="PastOrders" DataType="Collection[Domain.PastOrder]" Checked="False" />
        <Member Name="CoverageDays" DataType="int" Checked="False" />
        <Member Name="PalletSize" DataType="int" Checked="False" />
        <Member Name="SupplierPackSize" DataType="int" Checked="False" />
        <Member Name="InnerPackSize" DataType="int" Checked="False" />
        <Member Name="PalletType" DataType="string" Checked="False" />
        <Member Name="PalTI" DataType="int" Checked="False" />
        <Member Name="PalHI" DataType="int" Checked="False" />
        <Member Name="UOM" DataType="string" Checked="False" />
        <Member Name="SLALeadTimes" DataType="Collection[Domain.SLALeadTime]" Checked="False" />
        <Member Name="SLADeliveries" DataType="Collection[Domain.SLADelivery]" Checked="False" />
      </Members>
    </DataContract>
    <DataContract Name="" Class="Domain.PastOrder" BaseClass="">
      <Members>
        <Member Name="Id" DataType="int" Checked="False" />
        <Member Name="OrderNumber" DataType="int" Checked="True" />
        <Member Name="WrittenDate" DataType="DateTime" Checked="True" />
        <Member Name="NotBeforeDate" DataType="DateTime" Checked="True" />
        <Member Name="QuantityOrdered" DataType="int" Checked="True" />
        <Member Name="ReceiveDate" DataType="DateTime" Checked="True" />
        <Member Name="QuantityReceived" DataType="int" Checked="True" />
        <Member Name="Item" DataType="Domain.Item" Checked="True" />
        <Member Name="Warehouse" DataType="Domain.Warehouse" Checked="True" />
        <Member Name="Caller" DataType="string" Checked="True" />
      </Members>
    </DataContract>
    <DataContract Name="" Class="Domain.Response" BaseClass="">
      <Members>
        <Member Name="Id" DataType="int" Checked="False" />
        <Member Name="Status" DataType="string" Checked="True" />
        <Member Name="Message" DataType="string" Checked="True" />
        <Member Name="Details" DataType="string" Checked="True" />
        <Member Name="Code" DataType="string" Checked="True" />
      </Members>
    </DataContract>
    <DataContract Name="" Class="Domain.StockOnHand" BaseClass="">
      <Members>
        <Member Name="Id" DataType="int" Checked="False" />
        <Member Name="Units" DataType="int" Checked="True" />
        <Member Name="Warehouse" DataType="Domain.Warehouse" Checked="True" />
        <Member Name="Item" DataType="Domain.Item" Checked="True" />
        <Member Name="CurrentInventoryDays" DataType="decimal" Checked="False" />
        <Member Name="StockOnHandDate" DataType="DateTime" Checked="False" />
        <Member Name="LeadTime" DataType="string" Checked="False" />
        <Member Name="TargetInventoryDays" DataType="decimal" Checked="False" />
        <Member Name="FullTrackLoad" DataType="bool" Checked="False" />
        <Member Name="WDDays" DataType="bool" Checked="False" />
        <Member Name="Agreement" DataType="Domain.Agreement" Checked="False" />
      </Members>
    </DataContract>
    <DataContract Name="" Class="Domain.SupplierCapacity" BaseClass="">
      <Members>
        <Member Name="Id" DataType="int" Checked="False" />
        <Member Name="DateOfStockUpdate" DataType="DateTime" Checked="False" />
        <Member Name="DailyProduction" DataType="int" Checked="False" />
        <Member Name="Stock" DataType="int" Checked="False" />
        <Member Name="Item" DataType="Domain.Item" Checked="False" />
        <Member Name="Supplier" DataType="Domain.Supplier" Checked="False" />
      </Members>
    </DataContract>
    <DataContract Name="" Class="Domain.Warehouse" BaseClass="">
      <Members>
        <Member Name="Id" DataType="int" Checked="True" />
        <Member Name="Code" DataType="string" Checked="True" />
        <Member Name="Description" DataType="string" Checked="True" />
        <Member Name="PastOrders" DataType="Collection[Domain.PastOrder]" Checked="False" />
      </Members>
    </DataContract>
  </DataContracts>
</ExposedApi>