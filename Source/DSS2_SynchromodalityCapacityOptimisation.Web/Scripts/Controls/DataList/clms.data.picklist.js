/* Copyright (c) CLMS. All rights reserved.
 * Licensed under the AGPL-3.0 license. See LICENSE file in the project root for full license information.
 * This source file was autogenerated by zAppDev(r). */
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Joove;
(function (Joove) {
    var Widgets;
    (function (Widgets) {
        var JbDataPickList = (function (_super) {
            __extends(JbDataPickList, _super);
            function JbDataPickList() {
                return _super !== null && _super.apply(this, arguments) || this;
            }
            return JbDataPickList;
        }(Joove.BaseAngularProvider));
        var DataPickListControl = (function () {
            function DataPickListControl(element, options) {
                this.$element = element;
                this.$clearAllButton = this.$element.next(".picklist-clear-selection-button");
                this.options = $.extend(this.options, options);
                var indexes = Joove.Common.getIndexesOfControl(this.$element);
                var elementId = this.$element.attr("jb-id");
                this.popupName = this.$element.attr("jb-id") + indexes.key;
                Widgets.DataPickListControl.instancesDic[elementId + indexes.key] = this;
                this.configureEvents();
            }
            Object.defineProperty(DataPickListControl.prototype, "isBoundToRoot", {
                get: function () {
                    return this.$element.attr("ng-owner") === "model";
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(DataPickListControl.prototype, "selectedItemKeys", {
                get: function () {
                    var directiveScope = Joove.Common.getDirectiveScope(this.$element);
                    return Joove.DatasourceManager.getKeys(directiveScope.model);
                },
                enumerable: true,
                configurable: true
            });
            DataPickListControl.prototype.initializePickList = function () {
                if (this.$element.attr("initialized") == "true")
                    return;
                var elementID = this.$element.attr("jb-id");
                var $table = this.$element.parent().find("[jb-id='" + elementID + "_PickList']");
                var dtScope = Joove.Common.getDirectiveScope($table);
                var indexes = Joove.Common.getIndexesOfControl(this.$element);
                var uniqueId = Joove.Common.createRandomId(8);
                this.$element.attr("unique-id", uniqueId);
                $table.attr("unique-id", uniqueId);
                dtScope.initialize();
                this.dataList = Widgets.DataListControl.instancesDic[Joove.Core.GetElementNameFromId(elementID) + "_PickList" + uniqueId];
                if (this.dataList === undefined) {
                    this.handleError("PICKLIST ERROR: DataList control with id: \"" + elementID + "_PickList\" was not found. Aborting initialization.");
                    return;
                }
                this.dataList.init(this.$element);
                this.dataList.$wrapperElement.detach();
                this.configurePopUp();
                this.$element.attr("initialized", "true");
            };
            DataPickListControl.prototype.configurePopUp = function () {
                var _this = this;
                window._popUpManager.destroyPopUp(this.popupName);
                window._popUpManager.registerPopUp({
                    name: this.popupName,
                    width: "90%",
                    height: "80%",
                    cancelButton: true,
                    okButton: true,
                    okCallback: function () { _this.okCallback(); },
                    title: window._resourcesManager.getPickListModalTitle(this.$element, this.options.fromMasterPage),
                    $elementContent: this.dataList.$wrapperElement,
                    closeCallback: function () { _this.closeCallback(); }
                });
                $(document).keyup(function (e) {
                    if (e.which === 27) {
                        window._popUpManager.hidePopUp(_this.popupName);
                    }
                });
            };
            DataPickListControl.prototype.configureEvents = function () {
                var _this = this;
                this.$element.on("click", function () {
                    _this.initializePickList();
                    _this.dataList.$wrapperElement.addClass("hide-content");
                    if (_this.options.excludeSelected) {
                        _this.dataList.status.allKeysSelected = false;
                        _this.dataList.status.selectedKeys = [];
                        _this.dataList.status.selectedItems = [];
                        _this.dataList.status.excludedKeys = _this.selectedItemKeys;
                    }
                    else {
                        _this.dataList.setSelectedItemKeys(_this.selectedItemKeys);
                    }
                    _this.dataList.$wrapperElement.find(".actions button").hide();
                    _this.dataList.drawCallbackExtraFunctionality = function () {
                        _this.dataList.$wrapperElement.removeClass("hide-content");
                        _this.dataList.updateActionButtonVisibility();
                        _this.dataList.drawCallbackExtraFunctionality = null;
                    };
                    window._popUpManager.showPopUp(_this.popupName);
                    _this.dataList.dataTableInstance.draw();
                    _this.dataList.updateDataTableSize();
                });
                this.$clearAllButton.on("click", function () {
                    var self = _this;
                    window._popUpManager.question(window._resourcesManager.getPicklistClearConfirmation(), "", function (confirm) {
                        if (confirm == false)
                            return;
                        self.initializePickList();
                        self.dataList.deselectAll();
                        self.okCallback(true);
                    });
                });
            };
            DataPickListControl.prototype.okCallback = function (forClearSelectionButton) {
                var _this = this;
                if (!this.dataList.status.allKeysSelected) {
                    var directiveScope = Joove.Common.getDirectiveScope(this.dataList.$scopeElement);
                    var selectedItemKeys = this.dataList.status.selectedItems.map(function (item) { return item._key; });
                    if (forClearSelectionButton !== true &&
                        this.selectedItems == undefined &&
                        this.options.excludeSelected &&
                        this.selectedItemKeys.length > 0 &&
                        this.dataList.options.hasMultiSelect) {
                        selectedItemKeys = this.selectedItemKeys.concat(selectedItemKeys);
                    }
                    var type = Joove.DatasourceManager.getDatasetType(this.$element);
                    if (type == Joove.DataSourceTypes.VIEWMODEL) {
                        var selectedItemsData = Joove.DatasourceManager.fetchItemsFromViewModelDataset(this.$element, selectedItemKeys, false);
                        this.dataList.status.selectedItems = selectedItemsData;
                        this.dataList.updateDirectiveScopeAndModel(false);
                        this.handleSelectedItems(forClearSelectionButton);
                    }
                    else {
                        this.dataList.$loadingPanel.show();
                        Joove.DatasourceManager.requestSelectedItemsfromServer(this.dataList.serversideElementId, this.dataList.$scopeElement, directiveScope.itemDataType, this.dataList.status.allKeysSelected, selectedItemKeys, this.dataList.status.excludedKeys, this.dataList.prepareDatasourceRequestInfo(), function (selectedItemsData) {
                            _this.dataList.$loadingPanel.hide();
                            if (!Joove.Common.isArray(selectedItemsData)) {
                                selectedItemsData = [selectedItemsData];
                            }
                            _this.dataList.status.selectedItems = selectedItemsData;
                            _this.dataList.updateDirectiveScopeAndModel(false);
                            _this.handleSelectedItems(forClearSelectionButton);
                        });
                    }
                }
                else {
                    this.handleSelectedItems(forClearSelectionButton);
                }
            };
            DataPickListControl.prototype.closeCallback = function () {
            };
            DataPickListControl.prototype.handleSelectedItems = function (forClearSelectionButton) {
                Joove.DatasourceManager.invokeOnChangeHandler(this.$element);
                var dtoTypeName = this.$element.attr("jb-client-dto");
                if (forClearSelectionButton === true ||
                    !this.options.excludeSelected ||
                    this.selectedItems == undefined ||
                    !this.dataList.options.hasMultiSelect) {
                    this.selectedItems = [];
                }
                var dtoType = window[window._context.appName]["ViewModels"][window._context.currentController][dtoTypeName];
                if (dtoType == null) {
                    this.handleError("PICKLIST ERROR: Couldn't find DTO type: " + dtoTypeName);
                }
                for (var i = 0; i < this.dataList.status.selectedItems.length; i++) {
                    if (dtoType != null) {
                        this.selectedItems.push(dtoType._initializeFrom(this.dataList.status.selectedItems[i]));
                    }
                    else {
                        this.selectedItems.push(this.dataList.status.selectedItems[i]);
                    }
                }
                this.updateModel();
            };
            DataPickListControl.prototype.updateModel = function () {
                var directiveScope = Joove.Common.getDirectiveScope(this.$element);
                directiveScope.model = this.dataList.options.hasMultiSelect ? this.selectedItems : this.selectedItems[0];
                if (this.options.owner != undefined) {
                    var modelPath = this.$element.attr("ng-model");
                    var parts = modelPath.split(".");
                    var last = parts[parts.length - 1];
                    if (this.isBoundToRoot) {
                        this.options.owner[last] = directiveScope.model;
                    }
                    else {
                        Joove.Core.setBoClassPropertyFromInstance(last, this.options.owner, directiveScope.model);
                    }
                }
                var scope = this.options.fromMasterPage ? Joove.Common.getMasterScope() : directiveScope;
                Joove.Core.applyScope(scope);
                window.$refreshLogic();
            };
            DataPickListControl.prototype.handleError = function (error) {
                console.log(error);
            };
            DataPickListControl.instancesDic = {};
            return DataPickListControl;
        }());
        Widgets.DataPickListControl = DataPickListControl;
        function jbDataPickList(jbDataPickList) {
            return {
                priority: 1001,
                restrict: "AE",
                require: "?ngModel",
                scope: {
                    model: "=ngModel",
                    owner: "=ngOwner",
                    itemDataType: "=ngDatatype",
                    excludeSelected: "=ngExclude"
                },
                link: function ($scope, $element) {
                    if (Joove.Common.directiveScopeIsReady($element))
                        return;
                    Joove.Common.setDirectiveScope($element, $scope);
                    var picklistOptions = {};
                    picklistOptions.fromMasterPage = $scope.fromMasterForm === true;
                    picklistOptions.model = $scope.model;
                    picklistOptions.owner = $scope.owner;
                    picklistOptions.itemDataType = $scope.itemDataType;
                    picklistOptions.excludeSelected = $scope.excludeSelected;
                    var _initInterval = setInterval(function () {
                        if (Joove.Common.getIndexesOfControl($element) == null)
                            return;
                        clearInterval(_initInterval);
                        $scope.pickList = new Widgets.DataPickListControl($element, picklistOptions);
                    }, 250);
                    Joove.Common.markDirectiveScopeAsReady($element);
                }
            };
        }
        angular.module("jbDataPickList", [])
            .provider("jbDataPickList", new JbDataPickList())
            .directive("jbDataPickList", ["jbDataPickList", jbDataPickList]);
    })(Widgets = Joove.Widgets || (Joove.Widgets = {}));
})(Joove || (Joove = {}));
